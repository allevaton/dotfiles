#!/usr/bin/bash
#
#
#

if [[ "$EUID" != "0" ]]
then
    echo 'updatemirrors: must be run as root'
    exit 1
fi

verbose=0
num=6

while [[ $1 ]]
do
    case "$1" in
        -v|--verbose) verbose=1 ;;
        -n|--num) shift; num=$1 ;;
        -h|--help)
            cat <<EOF
Usage: `echo $0 | tr "/" "\n" | tail -n 1` [-v] [-n NUM] [-h]

    -h|--help           show this message
    -v|--verbose        show the output of rankmirrors
    -n|--num NUM        use NUM number of mirrors to rank

EOF
            exit 0
            ;;
    esac
    shift
done

echo -n 'updating mirrorlist... '

if [[ $verbose == 1 ]]
then
    $(which rankmirrors) -n $num /etc/pacman.d/mirrorlist | tee /tmp/mirrorlist
else
    $(which rankmirrors) -n $num /etc/pacman.d/mirrorlist > /tmp/mirrorlist
fi

# lock pacman to move the file
echo $$ > /var/lib/pacman/db.lck
mv /tmp/mirrorlist /etc/pacman.d/mirrorlist
chmod 644 /etc/pacman.d/mirrorlist
rm /var/lib/pacman/db.lck

echo 'done'
